---
title: "Pineal Gland Experiment 2 - Day"
author: "Joseph Mays"
output:
  html_notebook: 
      toc: true
      toc_depth: 2
      toc_float:
        collapsed: false
  html_document: 
    toc: true
    toc_depth: 2
  pdf_document: default
---

Two Day Samples, 10X Genomics 3'; Seurat v3.0.0

# Setup
## Merge Original Seurat Objects
```{r Pineal2_Day1n2 Merge, message=FALSE, warning=FALSE, results='hide'}
Pineal2_Day1n2 <- merge(Pineal2_Day1, Pineal2_Day2, project = "Pineal2_Day1n2", add.cell.ids = c("D1","D2"), merge.data = T)
#Doublets previously identified are removed here 
load("./R_Objects/master.doublets.day.Robj")
Pineal2_Day1n2@meta.data$treatment <- "Day"
Pineal2_Day1n2 <- subset(Pineal2_Day1n2, cells = setdiff(colnames(GetAssayData(Pineal2_Day1n2)), master.doublets.day))
Pineal2_Day1n2 <- ScaleData(Pineal2_Day1n2, verbose = F)
```

## QC Stats
```{r QC stats}
Pineal2_Day1n2
FeatureScatter(Pineal2_Day1, "nCount_RNA","nFeature_RNA")
VlnPlot(Pineal2_Day1n2, features = c("nCount_RNA","nFeature_RNA","percent.mito"), ncol=3, group.by = "orig.ident", pt.size = 0)
```
# Dimensional Reduction - All Cells
## Identify Highly Variable Genes
```{r Find Variable Genes, message=FALSE, results='hide'}
Pineal2_Day1n2 <- FindVariableFeatures(Pineal2_Day1n2, selection.method = "mean.var.plot", mean.cutoff = c(0.0125,3), dispersion.cutoff = c(0.3,Inf), verbose = F, do.plot = F)
print(paste(length(VariableFeatures(Pineal2_Day1n2)), " variable genes selected.", sep=""))
```

## Principal Components Analysis 
```{r PCA I, message=FALSE, warning=FALSE}
Pineal2_Day1n2 <- RunPCA(Pineal2_Day1n2, npcs = 40, verbose = F)
Pineal2_Day1n2 <- ProjectDim(Pineal2_Day1n2, verbose = F)
```
```{r PCA Plot I, message=FALSE, warning=FALSE}
PCAPlot(Pineal2_Day1n2, no.legend = T)
ElbowPlot(Pineal2_Day1n2, ndims = 40)
DimHeatmap(Pineal2_Day1n2, dims = 1:6)
DimHeatmap(Pineal2_Day1n2, dims = 7:12, balanced = T)
DimHeatmap(Pineal2_Day1n2, dims = 13:18, balanced = T)
```
## tSNE Projection
```{r Clustering, echo=TRUE, message=FALSE, warning=FALSE}
cluster.dims <- c(1:13)
cluster.res <- 1.5

Pineal2_Day1n2 <- FindNeighbors(Pineal2_Day1n2, dims = cluster.dims, reduction = "pca", do.plot = F)
Pineal2_Day1n2 <- FindClusters(Pineal2_Day1n2, resolution = cluster.res, verbose = F)
```

```{r Generate TSNE, echo=TRUE, message=FALSE, warning=FALSE}
Pineal2_Day1n2 <- RunTSNE(Pineal2_Day1n2, dims = cluster.dims)
```

```{r plot TSNE, message=FALSE, results = 'hide'}
Pineal2_Day1n2 <- BuildClusterTree(Pineal2_Day1n2, reorder = F, reorder.numeric = F)
PlotClusterTree(Pineal2_Day1n2)
TSNEPlot(Pineal2_Day1n2, label = T, repel= T) + ggtitle(paste("Day1n2, PCs ", cluster.dims[1],"-",length(cluster.dims),", res = ", cluster.res, sep=''))
TSNEPlot(Pineal2_Day1n2, label = T, group.by = "orig.ident", repel = T)
FeaturePlot(Pineal2_Day1, "nCount_RNA", cols = c("light grey","blue"))
FeaturePlot(Pineal2_Day1, "nFeature_RNA", cols = c("light grey","blue"))
```
## Cluster Identification by Markers
```{r Markers}
FeaturePlot(Pineal2_Day1n2, c("Tph1","Asmt","Esm1","Apoe","Penk","Lum","Vwf","Sparcl1","Lyz2","C1qa","RT1-Bb"), cols=c("light grey","red"))
DotPlot(object = Pineal2_Day1n2,features = c("Tph1","Asmt","Esm1","Apoe","Penk","Lum","Vwf","Sparcl1","Lyz2","C1qa","RT1-Bb", "S100b"))+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
### Rename Clusters
```{r Cluster Rename}
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "8" = "Penk 1")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "17" = "Penk 2")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "16" = "Penk 3")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "14" = "Lum")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "15" = "Lyz2")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "18" = "Lyz2")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, "13" = "High_Asmt_Tph1")
Pineal2_Day1n2 <- RenameIdents(Pineal2_Day1n2, '0' = "Tph1", '1' = "Tph1", '2' = "Tph1", '3' = "Tph1", '4' = "Tph1", '5' = "Tph1", '6' = "Tph1", '7' = "Tph1", '9' = "Tph1", '10' = "Tph1",'11' = "Tph1", '12' = "Tph1")
TSNEPlot(Pineal2_Day1n2, label = T, repel = T)
```

# Dimensional Reduction - Non-Pinealocytes
Non-Pinealocytes were analyized separately to resolve cell subtypes.
```{r Non-Pinealocyte}
Pineal2_Day1n2[["major.types"]] <- Idents(object = Pineal2_Day1n2)
Pineal2_Day1n2_NonP <- subset(Pineal2_Day1n2, idents = c("Tph1", "High_Asmt_Tph1"), invert = T)
TSNEPlot(Pineal2_Day1n2_NonP, label = T, repel = T)
```
## Identify Highly Variable Genes
```{r Find Variable Genes II, message=FALSE, results='hide'}
Pineal2_Day1n2_NonP <- FindVariableFeatures(Pineal2_Day1n2_NonP,selection.method = "mean.var.plot", mean.cutoff = c(0.05,3), dispersion.cutoff = c(0.4,Inf), verbose = F, do.plot = F)
print(paste(length(VariableFeatures(Pineal2_Day1n2_NonP)), " variable genes selected.", sep=""))
```

## Principal Components Analysis
```{r PCA II, message=FALSE, warning=FALSE}
Pineal2_Day1n2_NonP <- RunPCA(Pineal2_Day1n2_NonP, npcs = 40, verbose = F)
Pineal2_Day1n2_NonP <- ProjectDim(Pineal2_Day1n2_NonP, verbose = F)
```
```{r PCA Plot II, message=FALSE, warning=FALSE}
PCAPlot(Pineal2_Day1n2_NonP, no.legend = T)
ElbowPlot(Pineal2_Day1n2_NonP, ndims = 40)
DimHeatmap(Pineal2_Day1n2_NonP, dims = 1:6)
DimHeatmap(Pineal2_Day1n2_NonP, dims = 7:12, balanced = T)
```

## tSNE Projection
```{r Clustering II, echo=TRUE, message=FALSE, warning=FALSE}
cluster.dims <- c(1:10)
cluster.res <- 0.6

Pineal2_Day1n2_NonP <- FindNeighbors(Pineal2_Day1n2_NonP, dims = cluster.dims, reduction = "pca", do.plot = F)
Pineal2_Day1n2_NonP <- FindClusters(Pineal2_Day1n2_NonP, resolution = cluster.res, verbose = F)
```

```{r Generate TSNE II, echo=TRUE, message=FALSE, warning=FALSE}
Pineal2_Day1n2_NonP <- RunTSNE(Pineal2_Day1n2_NonP, dims = cluster.dims)
```

```{r Plot TSNE II, echo=TRUE, message=FALSE}
Pineal2_Day1n2_NonP <- BuildClusterTree(Pineal2_Day1n2_NonP, reorder = F, reorder.numeric = F)
PlotClusterTree(Pineal2_Day1n2_NonP)
TSNEPlot(Pineal2_Day1n2_NonP, label = T, repel= T) + ggtitle(paste("Day1n2 - Non-pinealocytes, PCs ", cluster.dims[1],"-",length(cluster.dims),", res = ", cluster.res, sep=''))
TSNEPlot(Pineal2_Day1n2_NonP, label = T, group.by = "orig.ident", repel = T)
TSNEPlot(Pineal2_Day1n2_NonP, label = T, group.by = "major.types", repel = T)
```

## Cluster Identification by Markers
```{r Markers II}
FeaturePlot(Pineal2_Day1n2_NonP, c("Esm1","Apoe","Penk","Lum","Vwf","Lyz2","C1qa","RT1-Bb"), cols=c("light grey","red"))
DotPlot(object = Pineal2_Day1n2_NonP, features = c("Esm1","Apoe","Penk","Lum","Vwf","Sparcl1","Lyz2","C1qa","RT1-Bb", "S100b"))+ theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

### Rename Clusters
```{r Cluster Rename II}
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "2" = "Lum")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "5" = "Penk 3")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "6" = "Penk 2")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "0" = "Penk 1")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "1" = "Penk 1")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "3" = "Penk 1")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "4" = "C1qa")
Pineal2_Day1n2_NonP <- RenameIdents(Pineal2_Day1n2_NonP, "7" = "RT1-Bb")
#Vwf+ cells isolated manually from the Lum+ group
load("./R_Objects/Vwf.Day.Robj")
Pineal2_Day1n2_NonP <- SetIdent(Pineal2_Day1n2_NonP, cells = Vwf.Day, value = "Vwf")
TSNEPlot(Pineal2_Day1n2_NonP, label = T, repel = T)
```

#Remap Clusters
```{r Cluster Rename III}
Pineal2_Day1n2 <- SetIdent(Pineal2_Day1n2, cells = WhichCells(Pineal2_Day1n2_NonP, idents = "RT1-Bb"), value = "RT1-Bb")
Pineal2_Day1n2 <- SetIdent(Pineal2_Day1n2, cells = WhichCells(Pineal2_Day1n2_NonP, idents = "C1qa"), value = "C1qa")
Pineal2_Day1n2 <- SetIdent(Pineal2_Day1n2, cells = WhichCells(Pineal2_Day1n2_NonP, idents = "Vwf"), value = "Vwf")
Idents(Pineal2_Day1n2) = factor(Idents(Pineal2_Day1n2),levels(Idents(Pineal2_Day1n2))[c(5,4,9,8,7,2,3,6,1)])
TSNEPlot(Pineal2_Day1n2, label = T, repel = T)
```

```{r}
sessionInfo()
```